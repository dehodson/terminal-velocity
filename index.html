<!doctype html>
<html>
<head>
	<link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
	<style>
		body, html{
			height:100%;
			margin:0;
			color: #2F2;
			background-color: #000;
			font-family: "Inconsolata", monospace;
			font-size: 3vmin;
		}
		#main-container{
			width: 95vmin;
			height: 95vmin;
			position: absolute;
			top:   0vmin;
			left:  0vmin;
			bottom:0vmin;
			right: 0vmin;
			padding: 2.5vmin;
			margin:auto;
			transform: perspective(50vmin) rotateY(5deg) scale(.8,.8);
			background-color: #111;
			background-image: url("./scanlines.png");
			background-size: 100%;
			border-radius: 3vmin;
			box-shadow: 0vmin 0vmin 7vmin rgba(100, 200, 100, 0.5);
			overflow: hidden;
		}
		#textbox{
			width:55.5vmin;
			height:93vmin;
			position: absolute;
			left:2.5vmin;
			top:2.5vmin;
			padding:.5vmin;
			color:#2F2;
			background: transparent;
			border: .5vmin solid #2F2;
			font-family: "Inconsolata", monospace;
			font-size: 3vmin;
			resize: none;
		}
		#description{
			width:33vmin;
			height:69vmin;
			border: .5vmin solid #2F2;
			padding:.5vmin;
			right: 2.5vmin;
			top: 2.5vmin;
			position: absolute;
		}
		#title{
			font-weight: bold;
		}
		#output{
			width:33vmin;
			height:20vmin;
			bottom:2.7vmin;
			right:2.5vmin;
			border: .5vmin solid #2F2;
			padding:.5vmin;
			position: absolute;
			text-align: center;
			line-height: 18vmin;
		}
		a:visited{
			color:#2F2;
		}
		a:link{
			color:#2F2;
		}
		a:hover{
			color:#7F7;
		}
		a:active{
			color:#2F2;
		}
		#alert{
			border: .5vmin solid #2F2;
			padding:.5vmin;
			text-align:center;
			width: 40vmin;
			height: 40vmin;
			position: absolute;
			top:   0vmin;
			left:  0vmin;
			bottom:0vmin;
			right: 0vmin;
			margin: auto;
			background-color: #111;
			background-image: url("./scanlines.png");
			background-size: 250%;
			z-index: 5;
			word-wrap: break-word;
		}
		#alert-title{
			font-weight: bold;
		}
		#alert-close{
			width: 100%;
			position: absolute;
			left:0vmin;
			bottom: 2.5vmin;
		}
		#overlay{
			width: 100%;
			height: 100%;
			position: absolute;
			top:0vmin;
			left: 0vmin;
			background-image: url("./scanlines.png");
			background-size: 100%;
		}
	</style>
	<title>Terminal Velocity</title>
</head>
<html>
	<body>
		<div id="main-container">

<textarea id="textbox" onkeydown="typing(event)">//type code in this box
//lines beginning with a double 
//slash will not be parsed

PRINT "test"
</textarea>
			<div id="description">
				<span id="title">Problem 1: Greet your computer.</span><br /><br />
				<span id="text">Write a program that prints "Hello computer!"<br /><br />To print, write <br />PRINT "your message"<br />on its own line.<br /><br />
					To run, hit "submit" below, or hit CTRL+S in the text box.</span>
			</div>
			<div id="output">
				<a href="#" onclick="parse();">submit</a>
			</div>
			<div id="overlay"></div>
			<div id="alert">
				<span id="alert-title">Hello World!</span><br /><br />
				<span id="alert-text">Thank you for your purchase of the TinkerCo 3250. We hope you think programming is as fun as we do. Let's make 2100 a great year for coding!</span>
				<div id="alert-close"><a href="#" onclick="closeAlert();">close</a></div>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		function showAlert(){
			document.getElementById("alert").style.visibility = "visible";
			document.getElementById("overlay").style.visibility = "visible";
		}

		function closeAlert(){
			document.getElementById("alert").style.visibility = "hidden";
			document.getElementById("overlay").style.visibility = "hidden";
		}

		function parse(){
			var program = document.getElementById("textbox").value;
			var programLines = program.match(/[^\r\n]+/g);
			var token  = "";
			var mode   = 0;

			var tree  = [];
			var place = -1;

			for(var i = 0; i < programLines.length; i++){
				var line = programLines[i];

				if(line.length > 2 && line[0] != "/" && line[1] != "/"){
					tree.push([]);
					place++;

					for(var j = 0; j < line.length; j++){
						if(mode == 0){
							if(line[j] == "\""){
								mode = 1;
								if(token != ""){
									tree[place].push(token);
									token = "";
								}
							}else if(line[j] != " " && line[j] != "\t" && line[j] != "\n"){
								token += line[j];
							}else{
								if(token != ""){
									tree[place].push(token);
									token = "";
								}
							}
						}else{
							if(line[j] == "\""){
								if(token != ""){
									tree[place].push(token);
									token = "";
								}
								mode = 0;
							}else{
								token += line[j];
							}
						}
					}
				}

				mode = 0;

				if(token != ""){
					tree[place].push(token);
					token = "";
				}
			}

			console.log(tree);

			var output = "";
			var labels    = {};
			var variables = {};
			var steps = 0;
			var success = true;
			var ifLevel = 1;

			function skipAhead(){
				for(var j = i + 1; j < tree.length; j++){
					if(tree[j][0] == "IF"){
						ifLevel++;
					}else if(tree[j][0] == "ENDIF"){
						ifLevel--;
					}

					if(ifLevel == 0){
						i = j;
						ifLevel = 1;
						break;
					}
				}
			}

			function toNum(n){
				if(variables.hasOwnProperty(tree[i][n])){
					return variables[tree[i][n]];
				}else{
					return parseInt(tree[i][n]);
				}
			}

			for(var i = 0; i < tree.length; i++){
				if(steps < 100000){
					if(tree[i][0].slice(-1) == ":"){
						labels[tree[i][0].slice(0, -1)] = i;
					}else if(tree[i][0] == "PRINT"){
						if(variables.hasOwnProperty(tree[i][1])){
							output += variables[tree[i][1]];
						}else{
							output += tree[i][1];
						}
					}else if(tree[i][0] == "GOTO"){
						if(labels.hasOwnProperty(tree[i][1])){
							i = labels[tree[i][1]];
						}
					}else if(tree[i][0] == "VAR"){
						variables[tree[i][1]] = toNum(3);
					}else if(tree[i][0] == "ADD"){
						variables[tree[i][1]] += toNum(2);
					}else if(tree[i][0] == "SUB"){
						variables[tree[i][1]] -= toNum(2);
					}else if(tree[i][0] == "IF"){
						if(tree[i][2] == "<"){
							if(toNum(1) >= toNum(3)){
								skipAhead();
							}
						}else if(tree[i][2] == ">"){
							if(toNum(1) <= toNum(3)){
								skipAhead();
							}
						}else if(tree[i][2] == ">="){
							if(toNum(1) < toNum(3)){
								skipAhead();
							}
						}else if(tree[i][2] == "<="){
							if(toNum(1) > toNum(3)){
								skipAhead();
							}
						}else if(tree[i][2] == "=="){
							if(toNum(1) != toNum(3)){
								skipAhead();
							}
						}
					}
					steps++;
				}else{
					document.getElementById("alert-title").innerText = "Error";
					document.getElementById("alert-text").innerText = "Uh oh! Something went wrong. Please inspect your code.";
					showAlert();

					success = false;

					break;
				}
			}

			if(success){
				document.getElementById("alert-title").innerText = "Program Output";
				document.getElementById("alert-text").innerText = output;

				showAlert();
			}
		}

		function typing(e){
			if(e.keyCode === 9) { // tab was pressed
				// get caret position/selection
				var $this = document.getElementById("textbox");

				var start = $this.selectionStart;
				var end = $this.selectionEnd;

				var value = $this.value;

				// set textarea value to: text before caret + tab + text after caret
				$this.value = value.substring(0, start)
				            + "  "
				            + value.substring(end);

				// put caret at right position again (add one for the tab)
				$this.selectionStart = $this.selectionEnd = start + 2;

				// prevent the focus lose
				e.preventDefault();
			}else if(e.ctrlKey && e.keyCode === 83){
				event.preventDefault();
				parse();
			}
		}
	</script>
</html>